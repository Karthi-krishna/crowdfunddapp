<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowdfunder dApp</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; transition: background-color 0.3s; }
        #connectWalletBtn { background-color: #f6851b; color: white; display: block; margin-bottom: 15px; } /* MetaMask Orange */
        #donateButton { background-color: #4CAF50; color: white; }
        #refundButton { background-color: #f44336; color: white; }
        #withdrawButton { background-color: #2196F3; color: white; }
        input[type="number"] { padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; width: 90%; }
        .status { margin-top: 20px; padding: 10px; border-radius: 4px; background-color: #e0f7fa; border: 1px solid #00bcd4; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Crowdfunder dApp Escrow</h2>
        
        <button id="connectWalletBtn">Connect Wallet</button>
        
        <p><strong>Goal:</strong> 10 ETH | **Deadline:** 30 days</p>
        <p><strong>Current Wallet:</strong> <span id="accountAddress">Not Connected</span></p>
        <p><strong>Contract Balance:</strong> <span id="contractBalance">Loading...</span> ETH</p>
        
        <hr>

        <h3>üôè Donate</h3>
        <input type="number" id="donationAmount" placeholder="ETH amount to donate (e.g., 1.0)" step="0.01" disabled>
        <button id="donateButton" disabled>Donate</button>

        <hr>

        <h3>‚öôÔ∏è Actions</h3>
        <button id="withdrawButton" disabled>Withdraw (Project Owner Only)</button>
        <button id="refundButton" disabled>Refund (Contributor Only)</button>

        <div class="status" id="statusMessage">Awaiting wallet connection...</div>
    </div>

    <script>
        // *********************************************************************************
        // *** 1. CONFIGURATION: REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL DEPLOYMENT DATA ***
        // Use the address from your truffle migrate output (0xECA9Ac2e4CC4336F7B75aDd26F26C91a7936C427)
        const CONTRACT_ADDRESS = "0xeca9ac2e4cc4336f7b75add26f26c91a7936c427"; 
        
        // Paste the entire array from build/contracts/Crowdfunder.json here
        const CONTRACT_ABI =  [
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_fundingGoal",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "_durationInDays",
          "type": "uint256"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "inputs": [],
      "name": "DeadlinePassed",
      "type": "error"
    },
    {
      "inputs": [],
      "name": "GoalAlreadyMet",
      "type": "error"
    },
    {
      "inputs": [],
      "name": "GoalMet",
      "type": "error"
    },
    {
      "inputs": [],
      "name": "GoalNotMet",
      "type": "error"
    },
    {
      "inputs": [],
      "name": "NoContribution",
      "type": "error"
    },
    {
      "inputs": [],
      "name": "NotProjectOwner",
      "type": "error"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "contributor",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "Contribution",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "totalAmount",
          "type": "uint256"
        }
      ],
      "name": "GoalReached",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "recipient",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "Payout",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "contributor",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "Refund",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "name": "contributions",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "currentBalance",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "deadline",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "fundingGoal",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "projectOwner",
      "outputs": [
        {
          "internalType": "address",
          "name": "",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "donate",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function",
      "payable": true
    },
    {
      "inputs": [],
      "name": "withdraw",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "refund",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ]
        // *********************************************************************************

        let provider;
        let signer;
        let crowdfunderContract;
        
        const statusMessage = document.getElementById('statusMessage');
        const accountAddress = document.getElementById('accountAddress');
        const contractBalanceEl = document.getElementById('contractBalance');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        
        // Elements to disable/enable
        const donationAmountInput = document.getElementById('donationAmount');
        const donateButton = document.getElementById('donateButton');
        const withdrawButton = document.getElementById('withdrawButton');
        const refundButton = document.getElementById('refundButton');


        // Function to enable all DApp elements upon successful connection
        function enableDApp() {
            connectWalletBtn.style.display = 'none'; // Hide the connect button
            donationAmountInput.disabled = false;
            donateButton.disabled = false;
            withdrawButton.disabled = false;
            refundButton.disabled = false;
        }

        async function connectWallet() {
            if (window.ethereum) {
                try {
                    // Use BrowserProvider to interface with MetaMask
                    provider = new ethers.BrowserProvider(window.ethereum);
                    
                    // Request accounts (prompts MetaMask connection)
                    const accounts = await provider.send("eth_requestAccounts", []);
                    signer = await provider.getSigner();
                    
                    crowdfunderContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    
                    accountAddress.textContent = accounts[0];
                    statusMessage.textContent = "‚úÖ Wallet Connected to Ganache Local DApp!";
                    
                    fetchContractData();
                    enableDApp(); // Enable interface upon success
                    
                    // Reload on account change
                    window.ethereum.on('accountsChanged', () => window.location.reload());
                } catch (error) {
                    // Log error but keep the connect button visible
                    statusMessage.textContent = `‚ùå Connection failed: ${error.message}`;
                    console.error("Connection Error:", error);
                }
            } else {
                statusMessage.textContent = "‚ùå MetaMask not found. Please install it.";
            }
        }

        async function fetchContractData() {
            if (!provider) return;
            try {
                // Get contract's ETH balance
                const balanceWei = await provider.getBalance(CONTRACT_ADDRESS);
                const balanceEth = ethers.formatEther(balanceWei);
                contractBalanceEl.textContent = `${balanceEth} ETH`;
            } catch (error) {
                console.error("Error fetching contract balance:", error);
                contractBalanceEl.textContent = "Error loading balance (Check Console).";
            }
        }

        // --- Event Listeners for DApp Functions ---

        document.getElementById('donateButton').addEventListener('click', async () => {
            if (!crowdfunderContract) return;
            const amountInput = donationAmountInput.value;
            if (!amountInput || parseFloat(amountInput) <= 0) return statusMessage.textContent = "Please enter a valid amount.";

            try {
                const amountWei = ethers.parseEther(amountInput);
                statusMessage.textContent = `Sending ${amountInput} ETH donation...`;

                const tx = await crowdfunderContract.donate({ value: amountWei });
                await tx.wait(); 

                statusMessage.textContent = `üéâ Donation successful! Hash: ${tx.hash.substring(0, 10)}...`;
                fetchContractData(); 
            } catch (error) {
                statusMessage.textContent = `‚ùå Donation failed: ${error.reason || error.message.substring(0, 80)}...`;
                console.error(error);
            }
        });

        document.getElementById('withdrawButton').addEventListener('click', async () => {
            if (!crowdfunderContract) return;
            try {
                statusMessage.textContent = "Attempting withdrawal...";
                const tx = await crowdfunderContract.withdraw();
                await tx.wait();
                statusMessage.textContent = "üí∞ Withdrawal successful! Check owner's balance.";
                fetchContractData();
            } catch (error) {
                statusMessage.textContent = `‚ùå Withdrawal failed: ${error.reason || error.message.substring(0, 80)}...`;
                console.error(error);
            }
        });

        document.getElementById('refundButton').addEventListener('click', async () => {
            if (!crowdfunderContract) return;
            try {
                statusMessage.textContent = "Attempting refund...";
                const tx = await crowdfunderContract.refund();
                await tx.wait();
                statusMessage.textContent = "üí∏ Refund successful! Check your wallet balance.";
                fetchContractData();
            } catch (error) {
                statusMessage.textContent = `‚ùå Refund failed: ${error.reason || error.message.substring(0, 80)}...`;
                console.error(error);
            }
        });

        // Event listener for the manual connection button
        connectWalletBtn.addEventListener('click', connectWallet);
    </script>
</body>
</html>w